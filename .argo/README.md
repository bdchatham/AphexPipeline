# Argo Configuration Templates

This directory contains **template files** that the `AphexPipelineStack` CDK construct uses to generate and deploy Argo Events and Argo Workflows configurations.

## Purpose

When you instantiate `AphexPipelineStack` in your CDK application, the construct:

1. Reads these template files
2. Substitutes variables (GitHub repo, bucket names, IAM roles, etc.)
3. Deploys the configurations to the EKS cluster via Helm or kubectl

**These files are NOT meant to be manually deployed.** They are templates used by the CDK construct.

## Files

### eventsource-github.yaml

Template for the GitHub EventSource that listens for webhook events.

**Variables substituted by the construct:**
- `${GITHUB_OWNER}`: GitHub organization/user
- `${GITHUB_REPO}`: Repository name
- `${GITHUB_BRANCH_REF}`: Branch reference to filter (e.g., refs/heads/main)
- `${GITHUB_TOKEN_SECRET_NAME}`: Kubernetes secret name for GitHub token
- `${GITHUB_WEBHOOK_SECRET_NAME}`: Kubernetes secret name for webhook validation
- `${EVENT_SOURCE_NAME}`: Name of the EventSource resource
- `${ARGO_EVENTS_NAMESPACE}`: Namespace for Argo Events

**Generated by**: `AphexPipelineStack` during deployment

### sensor-aphex-pipeline.yaml

Template for the Sensor that filters GitHub events and triggers workflows.

**Variables substituted by the construct:**
- `${WORKFLOW_TEMPLATE_NAME}`: Name of the WorkflowTemplate to trigger
- `${GITHUB_BRANCH_REF}`: Branch reference to filter (e.g., refs/heads/main)
- `${EVENT_SOURCE_NAME}`: EventSource name to listen to
- `${SENSOR_NAME}`: Name of the Sensor resource
- `${ARGO_EVENTS_NAMESPACE}`: Namespace for Argo Events
- `${ARGO_NAMESPACE}`: Namespace for Argo Workflows
- `${WORKFLOW_NAME_PREFIX}`: Prefix for generated workflow names

**Generated by**: `AphexPipelineStack` during deployment

### logging-config.yaml

Template for Argo Workflows logging configuration.

**Variables substituted by the construct:**
- `${ARTIFACT_BUCKET}`: S3 bucket name for log archives
- `${WORKFLOW_EXECUTION_ROLE_ARN}`: IAM role ARN for S3 access
- `${SERVICE_ACCOUNT_NAME}`: Service account name for workflow execution
- `${ARGO_NAMESPACE}`: Namespace for Argo Workflows

**Generated by**: `AphexPipelineStack` during deployment

## Usage in CDK

When you use AphexPipeline as a library:

```typescript
import { AphexPipelineStack } from 'aphex-pipeline';

new AphexPipelineStack(app, 'MyPipeline', {
  env: { account: '123456789012', region: 'us-east-1' },
  
  // These values are substituted into the templates
  githubOwner: 'bdchatham',
  githubRepo: 'my-repo',
  githubBranch: 'main',
  githubTokenSecretName: 'github-token',
  
  // The construct handles everything:
  // 1. Creates EKS cluster
  // 2. Installs Argo Workflows and Argo Events via Helm
  // 3. Reads these template files
  // 4. Substitutes variables
  // 5. Deploys configurations to the cluster
});
```

The construct automatically:
- Creates the GitHub webhook secret in Kubernetes
- Configures the EventSource with your repository
- Sets up the Sensor with branch filtering
- Configures logging with your S3 bucket
- Deploys all configurations to the cluster

## Customizing Templates

If you need to customize the Argo configurations:

### Option 1: Override in CDK (Recommended)

```typescript
new AphexPipelineStack(app, 'MyPipeline', {
  // ... other props
  
  // Override Argo Events configuration
  argoEventsConfig: {
    eventSourceTemplate: 'path/to/custom-eventsource.yaml',
    sensorTemplate: 'path/to/custom-sensor.yaml',
  },
  
  // Override logging configuration
  loggingConfig: {
    logRetentionDays: 60,
    archiveToS3: true,
    podGCStrategy: 'OnWorkflowSuccess',
  },
});
```

### Option 2: Extend the Stack

```typescript
import { AphexPipelineStack } from 'aphex-pipeline';

export class CustomPipelineStack extends AphexPipelineStack {
  constructor(scope: cdk.App, id: string, props: AphexPipelineStackProps) {
    super(scope, id, props);
    
    // Add custom Argo configurations
    this.addCustomEventSource({
      name: 'gitlab',
      type: 'gitlab',
      // ... custom config
    });
  }
}
```

### Option 3: Fork and Modify Templates

For advanced customization:
1. Fork the AphexPipeline repository
2. Modify the template files in `.argo/`
3. Use your fork as the dependency

## Template Variables Reference

### Common Variables

All templates support these variables:

- `${NAMESPACE}`: Kubernetes namespace (default: `argo` or `argo-events`)
- `${CLUSTER_NAME}`: EKS cluster name
- `${REGION}`: AWS region

### EventSource Variables

- `${EVENT_SOURCE_NAME}`: Name of the EventSource resource (default: `github`)
- `${ARGO_EVENTS_NAMESPACE}`: Namespace for Argo Events (default: `argo-events`)
- `${GITHUB_OWNER}`: GitHub organization or user
- `${GITHUB_REPO}`: Repository name
- `${GITHUB_TOKEN_SECRET_NAME}`: Kubernetes secret containing GitHub token (default: `github-access`)
- `${GITHUB_WEBHOOK_SECRET_NAME}`: Kubernetes secret for webhook validation (default: `github-webhook-secret`)

### Sensor Variables

- `${SENSOR_NAME}`: Name of the Sensor resource (default: `aphex-pipeline-sensor`)
- `${ARGO_EVENTS_NAMESPACE}`: Namespace for Argo Events (default: `argo-events`)
- `${EVENT_SOURCE_NAME}`: EventSource name to listen to (default: `github`)
- `${GITHUB_BRANCH_REF}`: Branch filter (e.g., `refs/heads/main`)
- `${WORKFLOW_TEMPLATE_NAME}`: WorkflowTemplate to trigger (default: `aphex-pipeline-template`)
- `${WORKFLOW_NAME_PREFIX}`: Prefix for generated workflow names (default: `aphex-pipeline-`)
- `${ARGO_NAMESPACE}`: Namespace for Argo Workflows (default: `argo`)

### Logging Variables

- `${ARGO_NAMESPACE}`: Namespace for Argo Workflows (default: `argo`)
- `${ARTIFACT_BUCKET}`: S3 bucket for log archives
- `${WORKFLOW_EXECUTION_ROLE_ARN}`: IAM role ARN with S3 access
- `${SERVICE_ACCOUNT_NAME}`: Service account name for workflow execution (default: `workflow-executor`)

## Workflow

When you deploy `AphexPipelineStack`:

```
CDK Deploy
    ↓
Create EKS Cluster
    ↓
Install Argo Workflows (Helm)
    ↓
Install Argo Events (Helm)
    ↓
Read Template Files (.argo/*.yaml)
    ↓
Substitute Variables
    ↓
Deploy to Cluster (kubectl apply)
    ↓
Configure GitHub Webhook
    ↓
Pipeline Ready!
```

## Manual Deployment (Not Recommended)

If you need to manually deploy these configurations (e.g., for testing):

1. **Set environment variables**:
   ```bash
   export GITHUB_OWNER="bdchatham"
   export GITHUB_REPO="my-repo"
   export GITHUB_BRANCH="main"
   export ARTIFACT_BUCKET="your-bucket"
   export WORKFLOW_EXECUTION_ROLE_ARN="arn:aws:iam::123456789012:role/WorkflowRole"
   ```

2. **Create GitHub token secret**:
   ```bash
   kubectl create secret generic github-access \
     --from-literal=token=<your-github-token> \
     -n argo-events
   ```

3. **Deploy with substitution**:
   ```bash
   envsubst < .argo/eventsource-github.yaml | kubectl apply -f -
   envsubst < .argo/sensor-aphex-pipeline.yaml | kubectl apply -f -
   envsubst < .argo/logging-config.yaml | kubectl apply -f -
   ```

**However, this is NOT the intended usage.** Use the CDK construct instead.

## Troubleshooting

### Template Substitution Errors

If you see errors about missing variables:
- Check that all required props are passed to `AphexPipelineStack`
- Verify the construct version supports the variables you're using

### Configuration Not Applied

If configurations aren't being applied:
- Check CDK deployment logs
- Verify kubectl has access to the cluster
- Check Argo Events and Argo Workflows are installed

### Custom Templates Not Loading

If custom templates aren't being used:
- Verify the file path is correct
- Ensure the file is included in your CDK app bundle
- Check CDK asset bundling configuration

## Testing

The Argo configurations are tested via:

1. **Property-based tests** for event parsing:
   ```bash
   cd pipeline-scripts
   pytest tests/test_github_event_properties.py -v
   ```

2. **CDK infrastructure tests** for template generation:
   ```bash
   cd pipeline-infra
   npm test
   ```

3. **Integration tests** (if available) for end-to-end workflow:
   ```bash
   npm run test:integration
   ```

## References

- [Library Usage Guide](../.kiro/docs/library-usage.md) - How to use AphexPipeline in your project
- [Architecture](../.kiro/docs/architecture.md) - System architecture
- [Operations Guide](../.kiro/docs/operations.md) - Monitoring and troubleshooting
- [Argo Workflows Documentation](https://argoproj.github.io/argo-workflows/)
- [Argo Events Documentation](https://argoproj.github.io/argo-events/)
